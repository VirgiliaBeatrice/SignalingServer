<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(document).ready(
            function () {
                var socket = io();
                var onTypes = {
                    sys_msg: 'system message',
                    pri_msg: 'private message',
                    pub_msg: 'public message',
                    user_reg: 'user register',
                    userL_push: 'user list push'
                };

                function User(username, userid) {
                    this.username = username;
                    this.userid = userid;
                }

                var messagePack = {};
                messagePack.caller = new User('', 0);
                messagePack.callee = new User('', 0);
                messagePack.msg = '';

                $('#name_btn').click(function () {
                    socket.emit(onTypes.user_reg, $('#name').val());
                    return false;
                });

                $('#message_btn').click(function () {
                    socket.emit(onTypes.pri_msg, $('#message_form').val());
                    return false;
                });

                socket.on(onTypes.sys_msg, function (msg) {
                    $('#message_detailed').append($('<li>').text(msg).addClass('msg_line'));
                });

                socket.on(onTypes.pri_msg, function (msg) {

                });

                socket.on(onTypes.userL_push, function (user_list_json) {
                    var user_list = JSON.parse(user_list_json);

                    $('#user_list_detailed').empty();

                    user_list.forEach(function (p1, p2, p3) {
                        if (p1.hasOwnProperty('username')) {
                            $('#user_list_detailed').append(
                                $('<li>').text(p1.username).addClass('user_line').attr(
                                    {"isSelected": 'false', "id" : p1.userid})
//                                (p2 + 1).toString()
                            );
                        }
                    });
                    $('li.user_line').click(function () {
                        var selected_user = $(this).text();

                        if ($(this).attr("isSelected") === 'false') {
                            $('label[for="message_form"]').after(
                                $('<p>').text(selected_user).addClass("selected user").attr(
                                    {"username": selected_user}
                                )
                            );
                            $(this).css({'color': 'red'}).attr({"isSelected": 'true'});
                        }
                        else {
                            var selector = 'p.selected.user[username="' + selected_user + '"]';
                            console.info(selector);
                            $(selector).remove();
                            $(this).css({'color': 'black'}).attr({"isSelected": 'false'});
                        }
                        return false;
                    });
                });


            }
        )
    </script>
</head>
<body>
    <div id="user_info">
        <label for="name">User Name:</label>
        <input type="text" id="name" />
        <button id="name_btn" class="btn enter">Enter</button>
    </div>
    <div id="message">
        <ul id="message_detailed"></ul>
    </div>
    <div id="user_list">
        <ul id="user_list_detailed"></ul>
    </div>
    <div id="input_form">
        <label for="message_form">Message:</label>
        <input type="text" id="message_form" />
        <button id="message_btn" class="btn enter">Enter</button>
    </div>
</body>
</html>