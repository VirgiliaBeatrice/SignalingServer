<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(document).ready(
            function () {
                var socket = io();
                var onTypes = {
                    sys_msg: 'system message',
                    user_msg: 'user message',
                    pri_msg: 'private message',
                    pub_msg: 'public message',
                    user_reg: 'user register',
                    userL_push: 'user list push'
                };

                function User(username, userid) {
                    this.username = username;
                    this.userid = userid;
                }
                var msg_pack = {};

                $('#name_btn').click(function () {
                    var user_name = $('#name').val();
                    socket.emit(onTypes.user_reg, user_name);
                    msg_pack.caller = new User(user_name, socket.id);

                    return false;
                });

                $('#message_btn').click(function () {
                    var msg_input = $('#message_form');
                    msg_pack.msg = msg_input.val();

                    socket.emit(onTypes.user_msg, JSON.stringify(msg_pack));

                    msg_input.val = '';
                    return false;
                });

                socket.on(onTypes.sys_msg, function (msg) {
                    $('#message_detailed').append($('<li>').text(msg).addClass('msg_line'));
                });

                socket.on(onTypes.user_msg, function (msg) {
                    var msg_pack = JSON.parse(msg);
                    var echo = '';

                    if (msg_pack.callee === undefined) {
                        echo = 'Public Message: ';
                    } else {
                        echo = 'Private Message from ' + msg_pack.caller.username + ': ';
                    }
                    $('#message_detailed').append($('<li>').text(echo + msg_pack.msg).addClass('msg_line'));
                });

                socket.on(onTypes.userL_push, function (user_list_json) {
                    var user_list = JSON.parse(user_list_json);

                    $('#user_list_detailed').empty();

                    user_list.forEach(function (p1, p2, p3) {
                        if (p1.hasOwnProperty('username')) {
                            $('#user_list_detailed').append(
                                $('<li>').text(p1.username).addClass('user_line').attr(
                                    {"isSelected": 'false', "id" : p1.userid})
//                                (p2 + 1).toString()
                            );
                        }
                    });

                    $('li.user_line').click(function () {
//                        var selected_username = $(this).text();
                        var selected_user = new User($(this).text(), $(this).attr('id'));

                        if ($(this).attr("isSelected") === 'false') {
                            $('label[for="message_form"]').after(
                                $('<p>').text(selected_user.username).addClass("selected user").attr(
                                    {"username": selected_user.username}
                                )
                            );
                            $(this).css({'color': 'red'}).attr({"isSelected": 'true'});
                            msg_pack.callee = selected_user;
                        }
                        else {
                            var selector = 'p.selected.user[username="' + selected_user.username + '"]';
//                            console.info(selector);
                            $(selector).remove();
                            $(this).css({'color': 'black'}).attr({"isSelected": 'false'});
                            msg_pack.callee = undefined;
                        }
                        return false;
                    });
                });


            }
        )
    </script>
</head>
<body>
    <div id="user_info">
        <label for="name">User Name:</label>
        <input type="text" id="name" />
        <button id="name_btn" class="btn enter">Enter</button>
    </div>
    <div id="message">
        <ul id="message_detailed"></ul>
    </div>
    <div id="user_list">
        <ul id="user_list_detailed"></ul>
    </div>
    <div id="input_form">
        <label for="message_form">Message:</label>
        <input type="text" id="message_form" />
        <button id="message_btn" class="btn enter">Enter</button>
    </div>
</body>
</html>